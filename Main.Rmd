---
title: "Quantile Regressions"
author: "Gorlevich Daniil"
date: "2023-12-09"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
##
```{r}
library(readxl)
library(zoo)
library(plotly)
library(dplyr)
library(dynlm)

source("Source/QADF.R") # Import QADF, I have customly written from (Koenker, Xiao, 2004)
source("Source/QGranger.R") # Import QGranger, works through F-test
source("Source/QECM.R")
source("Source/QQ.R")
source("Source/plotters.R")

options(scipen=999)
```

## Load and preprocess data

```{r}
# Get data, convert to ts format
data <- read_excel("EXDATA.xlsx")
date <- data$Date
values <- subset(data, select = -c(Date))

# log and approximate NA
zoo_values <- zoo(na.approx(log(values)), order.by = date)
ts_no_dates <- na.approx(ts(log(values)))

# Extract variables
ER_log <- ts_no_dates[, "ER"]
EPU_log <- ts_no_dates[, "EPU"]
TRD_log <- ts_no_dates[, "TRD"]
OP_log <- ts_no_dates[, "OP"]
# Quantiles of interest
taus <- seq(0.1, 0.9, 0.1)
```

## Visualization

### ER

```{r}
# Plot the data
ts_plot_ly(ER_log, date)
```

### EPU

```{r}
ts_plot_ly(EPU_log, date)
```

```{r}
ts_plot_ly(OP_log, date)
```

```{r}
ts_plot_ly(TRD_log, date)
```


## Quantile Augmented Dickey-Fuller Test

Select ARDF lag and trend presence:

### ER

```{r}
ER_adf <- QADF(ER_log, taus, 7)
```

### EPU

```{r}
EPU_adf <- QADF(EPU_log, taus, 7)
```

### OP

```{r}
OP_adf <- QADF(OP_log, taus, 7)
```

### TRD

```{r}
TRD_adf <- QADF(TRD_log, taus, 7)
```


### Granger Test

### ER to EPU

```{r}
ER_EPU_granger <- quantile_granger(ER_log, EPU_log, 3, taus)
```

### EPU to ER

```{r}
EPU_ER_granger <- quantile_granger(EPU_log, ER_log, 3, taus)
```

## QECM

### Control: Trade Volume

```{r}
QECM(ER_log, EPU_log, TRD_log, 3, 3, 3, taus)
```

### Control: Oil Price

```{r}
QECM(ER_log, EPU_log, OP_log, 3, 3, 3, taus)
```

## Quantile-in-Quantile

```{r}
source("Source/plotters.R")
QQ_EPU <- QQRegression(ER_log, EPU_log, taus, taus)
QQplot(QQ_EPU)
``` 
